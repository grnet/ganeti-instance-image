#!/bin/bash
set -e

INSTANCE_NAME="$1"

if test -z "$INSTANCE_NAME"; then
    printf Must provide a node name!\n'
    exit 1
fi

info="$(gnt-instance list -o os,hypervisor,disk.count --no-headers --separator=' ' "$INSTANCE_NAME")"
OS_VARIANT="${info[0]/*+/}"
HYPERVISOR="${info[1]}"
DISK_COUNT="${info[2]}"
OS_API_VERSION=20
output="$(gnt-instance activate-disks "$INSTANCE_NAME")"
DISK_0_PATH="`printf '%s' "$output" | sed -n -e '/disk\/0:/! b; s/^.*disk\/0://; p'`"

. "@osdir@/@osname@/common.sh"

cleanup push "gnt-instance deactivate-disks \"$INSTANCE_NAME\""
filesystem_dev="${DISK_0_PATH/\/dev\//}"
TARGET="/tmp/${INSTANCE_NAME}_root"
map_partition 'root'
map_partition 'boot'
umount_disk0 'temp'
BLOCKDEV="$DISK_0_PATH"
unmap_disk0
