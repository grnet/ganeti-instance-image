#!/bin/bash
set -e
INSTANCE_NAME="$1"

if test -z "$INSTANCE_NAME"; then
    printf 'Must provide a node name!\n'
    exit 1
fi

info="$(gnt-instance list -o os,hypervisor,disk.count --no-headers --separator=' ' "$INSTANCE_NAME")"
OS_VARIANT="${info[0]/*+/}"
HYPERVISOR="${info[1]}"
DISK_COUNT="${info[2]}"
OS_API_VERSION=20

# do stuff
output="$(gnt-instance activate-disks "$INSTANCE_NAME")"
CLEANUP+=("gnt-instance deactivate-disks \"$INSTANCE_NAME\"")

DISK_0_PATH="${output/*disk\/0\:/}"

. "@osdir@/@osname@/common.sh"

! test -n "$2" || IMAGE_DIR="$2"

filesystem_dev="$(map_disk0)"
CLEANUP+=('unmap_disk0')
root_dev="$(map_partition "$filesystem_dev" root)"
boot_dev="$(map_partition "$filesystem_dev" boot)"

if test -n "$boot_dev"; then
    printf 'Creating dump from %s for boot at %s/%s-%s-boot.dump\n' "$INSTANCE_NAME" "$IMAGE_DIR" "$IMAGE_NAME" "$ARCH"
    "$DUMP" -0 -q -z9 -f "${IMAGE_DIR}/${IMAGE_NAME}-${ARCH}-boot.dump" "$boot_dev"
fi

printf 'Creating dump from %s for root at %s/%s-%s-root.dump\n' "$INSTANCE_NAME" "$IMAGE_DIR" "$IMAGE_NAME" "$ARCH"
"$DUMP" -0 -q -z9 -f "${IMAGE_DIR}/${IMAGE_NAME}-${ARCH}-root.dump" "$root_dev"
