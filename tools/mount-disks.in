#!/bin/bash
set -e
INSTANCE_NAME="$1"

if test -z "$INSTANCE_NAME"; then
    printf 'Must provide a node name!\n'
    exit 1
fi

info="$(gnt-instance list -o os,hypervisor,disk.count --no-headers --separator=' ' "$INSTANCE_NAME")"
OS_VARIANT="${info[0]/*+/}"
HYPERVISOR="${info[1]}"
DISK_COUNT="${info[2]}"
OS_API_VERSION=20
output="$(gnt-instance activate-disks "$INSTANCE_NAME")"

DISK_0_PATH="`printf '%s' "$output" | sed -n -e '/disk\/0:/! b; s/^.*disk\/0://; p'`"

. "@osdir@/@osname@/common.sh"

filesystem_dev="$(map_disk0)"
root_dev="$(map_partition "$filesystem_dev" root)"
boot_dev="$(map_partition "$filesystem_dev" boot)"

TARGET="/tmp/${INSTANCE_NAME}_root"
$MKDIR_P "$TARGET"
mount_disk0
printf '%s is now mounted at %s\n' "$INSTANCE_NAME" "$TARGET"
cleanup uninit
